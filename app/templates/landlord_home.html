{% extends "templates/base.html" %}

{% block title %}Plot Information{% endblock %}

{% block main %}
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <ul class="flashes">
                {% for message in messages %}
                    <li>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <div class="form-container">
        <form id="myForm" action="/edit_plot" method="POST">
            <br><label for="plot_number">Plot Number:</label>
            <input type="text" name="plot_number" value="{{ plot.plot_number }}" required><br>

            <label for="phone_number">Phone Number:</label>
            <input type="text" name="phone_number" value="{{ plot.phone_number }}" required><br>

            <label for="total_houses">Total Houses:</label>
            <input type="number" name="total_houses" value="{{ plot.total_houses }}" required><br>

            <label for="email">Email:</label>
            <input type="email" name="email" value="{{ plot.email }}" required><br>

            <div class="location-container">
                <label for="location">Location:</label>
                <input type="text" name="location" value="{{ plot.location }}" required><br>
            </div>

            <label for="password1">Password:</label>
            <input type="password" name="password1" value="{{ plot.password1 }}" required><br>

            <input type="submit" value="Edit Information">
        </form>

        <div class="links-container">
            <h2>Links</h2>
            <a href="/add_tenant">Add Tenant</a><br>
            <a href="/edit_tenant">Edit Tenant</a><br>
            <a href="/add_house_info">Add New Houses</a><br>
            <a href="/screen-tenant">Screen Tenant</a><br>
        </div>
    </div>

    <div id="flash-messages"></div>

    <script>
        function updatePlot() {
            // Get the updated plot information from the input fields
            var updatedPhoneNumber = document.getElementsByName('phone_number')[0].value;
            var updatedTotalHouses = document.getElementsByName('total_houses')[0].value;
            var updatedEmail = document.getElementsByName('email')[0].value;
            var updatedLocation = document.getElementsByName('location')[0].value;
            var updatedPassword = document.getElementsByName('password1')[0].value;
    
            // Create the AJAX request
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/edit_plot', true);
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
    
            // Handle the AJAX response
            xhr.onload = function () {
                if (xhr.status === 200 && xhr.responseText === 'success') {
                    // Display success message
                    flashMessage('Plot information updated successfully!', 'success');
                } else if (xhr.responseText === 'no_update') {
                    // Display info message
                    flashMessage('No changes were made to the plot information.', 'info');
                } else {
                    // Handle other response statuses or errors
                    console.log('Error: ' + xhr.responseText);
                }
            };
    
            // Send the AJAX request with the updated plot information
            xhr.send(
                'phone_number=' +
                encodeURIComponent(updatedPhoneNumber) +
                '&total_houses=' +
                encodeURIComponent(updatedTotalHouses) +
                '&email=' +
                encodeURIComponent(updatedEmail) +
                '&location=' +
                encodeURIComponent(updatedLocation) +
                '&password1=' +
                encodeURIComponent(updatedPassword)
            );
        }
    
        function flashMessage(message, type) {
            var flashContainer = document.getElementById('flash-messages');
            var flashElement = document.createElement('div');
            flashElement.classList.add('flash-message');
            flashElement.classList.add(type);
            flashElement.textContent = message;
            flashContainer.appendChild(flashElement);
    
            // Remove flashed message after a certain duration
            setTimeout(function () {
                flashElement.remove();
            }, 3000); // 3 seconds duration
    
            // Clear existing flash messages after a certain duration
            setTimeout(function () {
                var flashes = document.getElementsByClassName('flash-message');
                for (var i = 0; i < flashes.length; i++) {
                    flashes[i].remove();
                }
            }, 3000); // 3 seconds duration
        }
    
        // Add event listener to the form submit event
        document.getElementById('myForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent the form from submitting normally
            updatePlot(); // Call the function to handle the AJAX request
        });
    </script>
    
{% endblock %}
